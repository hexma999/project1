<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ê²½ìˆ˜ì˜¤ë¹ ëª»í•´ì¡° - ë©”ì¸</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/static/css/common.css" rel="stylesheet" />

    <style>
    /* =============================================================
       0) Global reset + CSS variables
    ============================================================= */
    :root{
      --stickyTopH: 0px;
      --bubbleGap: 12px;
    }

    html, body{ margin:0; padding:0; }
    body{ padding-top: var(--stickyTopH); } 

    /* =============================================================
       [ì¶”ê°€ ìˆ˜ì • 1] ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ ìœ„ì¹˜ ê°•ì œ ì¡°ì • (ìˆ˜ì •ë¨)
       - bottom: autoë¥¼ ì¶”ê°€í•˜ì—¬ í•˜ë‹¨ ê³ ì • ì†ì„±ì„ ë¬´ë ¥í™”ì‹œí‚µë‹ˆë‹¤.
       - IDë‚˜ í´ë˜ìŠ¤ë¥¼ í™•ì‹¤í•˜ê²Œ ì¡ê¸° ìœ„í•´ ì„ íƒìë¥¼ ì—¬ëŸ¬ ê°œ ë‚˜ì—´í–ˆìŠµë‹ˆë‹¤.
    ============================================================= */
    .cart-floating, 
    .cart-btn-wrapper, 
    #cart-floating,
    div[class*="cart-floating"] { /* 'cart-floating'ì´ í¬í•¨ëœ ëª¨ë“  í´ë˜ìŠ¤ ì„ íƒ */
      
      position: fixed !important;
      
      /* âœ… ìœ„ì¹˜ ì¡°ì •ì€ ì´ ìˆ«ìë¥¼ ë°”ê¾¸ì„¸ìš” (PC ê¸°ì¤€) */
      top: 230px !important; 
      
      /* ì¤‘ìš”: ê¸°ì¡´ì˜ í•˜ë‹¨ ê³ ì • ì†ì„±ì„ í’€ì–´ì¤˜ì•¼ topì´ ë¨¹í™ë‹ˆë‹¤ */
      bottom: auto !important; 
      
      z-index: 60000 !important; 
    }

    /* =============================================================
       1) Sticky header container (#stickyTop)
    ============================================================= */
    #stickyTop{
      position: fixed;
      top: 15px; 
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 1140px; 
      z-index: 50000;
      background: transparent !important; 
      overflow: visible !important;
      display: flex;
      flex-direction: column;
    }

    #stickyTop > *{ margin: 0 !important; }

    #stickyTop .nav-bar-wrapper,
    #stickyTop .nav-bar,
    #stickyTop nav,
    #stickyTop nav.navbar{
      margin: 0 !important;
      padding: 0 !important;
      position: static !important;
      top: auto !important;
      transform: none !important;
    }

    /* í—¤ë” ë°”: ìœ„ìª½ ë‘¥ê¸€ê²Œ */
    #stickyTop .header-bar{
      position: relative !important;
      z-index: 2 !important;
      overflow: visible !important;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
      width: 100% !important;
      padding-left: 15px;
      padding-right: 15px;
    }

    /* ë©”ë‰´ ë°”: ì•„ë˜ìª½ ë‘¥ê¸€ê²Œ */
    #stickyTop .nav-bar-wrapper{
      position: relative !important;
      z-index: 1 !important;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 0 0 20px 20px;
      border-top: none !important;
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    
    #stickyTop .nav-bar {
      border-radius: 0 0 20px 20px; 
      background: transparent !important;
      box-shadow: none !important;
      border-bottom: none !important;
    }

    #stickyTop .header-bar .dropdown-menu{
      z-index: 9999 !important;
    }

    /* ë°˜ì‘í˜• ë„ˆë¹„ ì¡°ì ˆ */
    @media (max-width: 1199px) { #stickyTop { max-width: 960px; } }
    @media (max-width: 991px)  { #stickyTop { max-width: 720px; } }
    @media (max-width: 767px)  { 
      #stickyTop { 
        max-width: 100%; 
        top: 0; 
        border-radius: 0; 
      }
      #stickyTop .header-bar { border-radius: 0; }
      #stickyTop .nav-bar-wrapper { border-radius: 0 0 15px 15px; }
      
      /* âœ… ëª¨ë°”ì¼ì—ì„œì˜ ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ ìœ„ì¹˜ (ìˆ«ì ì¡°ì •) */
      .cart-floating, 
      .cart-btn-wrapper, 
      #cart-floating,
      div[class*="cart-floating"] {
        top: 100px !important;     /* ëª¨ë°”ì¼ì—ì„œ ì›í•˜ëŠ” ë†’ì´ */
        bottom: auto !important;   /* ì¤‘ìš” */
      }
    }


    /* =============================================================
       2) Header row (logo / search / menu)
    ============================================================= */
    #stickyTop .header-bar .logo{
      display: inline-flex !important;
      align-items: center !important;
      gap: 6px;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    #stickyTop .header-bar .logo .logo-text{
      font-size: 22px; 
      font-weight: 800;
      line-height: 1;
    }

    #stickyTop .header-bar form,
    #stickyTop .header-bar .search-form,
    #stickyTop .header-bar .search-box,
    #stickyTop .header-bar .search-container{
      flex: 1 1 auto !important;
      min-width: 220px !important;
      max-width: 560px !important;
    }

    #stickyTop .header-bar .dropdown,
    #stickyTop .header-bar .menu-wrapper,
    #stickyTop .header-bar .header-nav{
      flex: 0 0 auto !important;
    }

    @media (max-width: 700px){
      #stickyTop .header-bar .logo .logo-text{ display: none !important; }
    }

    @media (max-width: 900px){
      #stickyTop .header-bar .container,
      #stickyTop .header-bar .container-fluid{
        width: 100% !important;
        margin: 0 auto !important;
        padding-left: 10px !important;
        padding-right: 10px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 12px !important;
      }
    }


    /* =============================================================
       3) Navbar (ê°•ì•„ì§€/ê³ ì–‘ì´/ìƒˆ)
    ============================================================= */
    .nav-bar{ display:block !important; }

    .nav-bar-wrapper .navbar-collapse,
    .nav-bar-wrapper .navbar-collapse.collapse{
      display: block !important;
      height: auto !important;
      visibility: visible !important;
      overflow: visible !important;
    }

    .nav-bar-wrapper .navbar-nav{
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: nowrap !important;
      align-items: center !important;
      justify-content: center !important;
      white-space: nowrap;
      gap: 10px;
      padding: 4px 10px !important;
      margin: 0;
      overflow: visible !important;
    }

    .nav-bar-wrapper .navbar-nav .nav-item{ flex: 0 0 auto; }

    .nav-bar-wrapper .nav-link{
      padding: 6px 14px !important;
      font-size: 14px !important;
      line-height: 1.1 !important;
      padding-bottom: 12px !important;
      position: relative;
      white-space: nowrap;
    }
    .nav-bar-wrapper .nav-link i{ margin-right: 4px; }

    .nav-bar-wrapper .nav-link::after{
      content: "" !important;
      position: absolute !important;
      left: 10px !important;
      right: 10px !important;
      bottom: 4px !important;
      height: 2px !important;
      transform: none !important;
    }

    .nav-bar-wrapper .dropdown-menu{ z-index: 9999 !important; }

    @media (max-width: 680px){
      .nav-bar-wrapper{ padding: 6px 0 !important; }
      .nav-bar-wrapper .navbar-nav{
        gap: 10px !important;
        padding: 4px 10px !important;
        justify-content: center !important;
      }
      .nav-bar-wrapper .nav-link{
        padding: 6px 14px !important;
        font-size: 14px !important;
        padding-bottom: 12px !important;
      }
    }


    /* =============================================================
       4) Expiry bubbles (ë§í’ì„ )
    ============================================================= */
    .expiry-bubble{
      position: fixed;
      width: 210px;
      max-width: 88vw;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      padding: 10px 10px 8px;
      z-index: 2000;
      display: none;
      font-size: 13px;
      line-height: 1.25;
    }

    .expiry-bubble .bubble-title{ font-weight:800; margin-bottom:8px; }
    .expiry-remaining{ color:#6f42c1; font-weight:800; }
    .expiry-over{ color:#dc3545; font-weight:800; }

    .bubble-pointer{
      position:absolute;
      width:0; height:0;
      border-left:10px solid transparent;
      border-right:10px solid transparent;
      border-bottom:10px solid #fff3cd;
      top:-10px; left:18px;
    }

    .expiry-bubble .bubble-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
      align-items:stretch;
      flex-wrap: nowrap;
    }

    .expiry-bubble .bubble-actions > a,
    .expiry-bubble .bubble-actions > button{
      min-height: 9px;
      padding: 1px 3px;
      display:flex;
      align-items:center;
      justify-content:center;
      white-space: nowrap !important;
      word-break: keep-all !important;
      overflow-wrap: normal !important;
      font-size: 11px;
      line-height: 1;
      border-radius: 8px;
    }

    .bubble-btn-buy-top{ flex:5; }
    .bubble-btn-toggle{  flex:4; }

    .bubble-close-square{
      flex:1;
      aspect-ratio: 1 / 1;
      min-width: 22px;
      min-height: 22px;
      padding: 0;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.25);
      background:#fff;
      cursor:pointer;
      font-size: 16px;
    }

    .bubble-btn-buy-top,
    .bubble-btn-buy{
      background:#ff8a00 !important;
      border:1px solid #ff8a00 !important;
      color:#fff !important;
    }
    .bubble-btn-buy-top:hover,
    .bubble-btn-buy:hover{
      background:#111 !important;
      border-color:#111 !important;
    }

    .bubble-btn-toggle{
      background: transparent !important;
      border: 1px solid #ff8a00 !important;
      color: #ff8a00 !important;
      font-weight:700;
    }
    .bubble-btn-toggle:hover{ background: rgba(255,138,0,0.08) !important; }

    .bubble-list{
      display:none;
      margin-top:8px;
      padding-top:8px;
      border-top:1px dashed rgba(0,0,0,0.2);
      max-height:250px;
      overflow:auto;
    }

    .bubble-list > div > div:first-child{
      margin-bottom: 6px; 
    }

    .bubble-list .bubble-btn-buy{
      padding: 1px 6px !important;
      font-size: 11px !important;
      line-height: 1.2 !important;
      border-radius: 7px !important;
    }

    .expiry-bubble.in-rail{
      position: static !important;
      display:block !important;
      flex: 0 0 auto;
      align-self:flex-start;
    }
    .expiry-bubble.in-rail .bubble-pointer{ display:none; }
    .expiry-bubble.is-closed,
    .expiry-bubble.in-rail.is-closed{ display:none !important; }


    /* =============================================================
       [ì¶”ê°€ ìˆ˜ì • 2] Expiry bubble rail (ëª¨ë°”ì¼/ì¢ì€ í­ ë ˆì¼)
       - justify-contentë¥¼ centerì—ì„œ flex-startë¡œ ë³€ê²½í•˜ì—¬
         ìŠ¤í¬ë¡¤ ì‹œ ì™¼ìª½ì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ í•¨
    ============================================================= */
    .expiry-bubble-rail{
      display:none;
      position: fixed;
      left:0; right:0;
      top: calc(var(--stickyTopH) + var(--bubbleGap));
      z-index: 2500; 
      
      /* ì¢Œìš° ì—¬ë°±ì„ ì¶©ë¶„íˆ ì£¼ì–´ ìŠ¤í¬ë¡¤ ì‹œì‘ì  í™•ë³´ */
      padding: 0 20px; 
      gap: 12px;
      
      overflow-x: auto;
      overflow-y: visible;
      -webkit-overflow-scrolling: touch;
      
      /* ì¤‘ìš”: ìŠ¤í¬ë¡¤ ì‹œ ì™¼ìª½ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ flex-start ì‚¬ìš© */
      justify-content: flex-start; 
      align-items: flex-start;
    }


    /* =============================================================
       6) Main carousel / banner styles
    ============================================================= */
    .carousel-container{
      margin-top: 30px;
      margin-bottom: 50px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
    .carousel-item{
      height: 350px;
      background-color: #000;
    }
    .carousel-item img{
      height: 100%;
      width: 100%;
      object-fit: cover;
      opacity: 0.7;
    }
    .carousel-caption{
      bottom: 50%;
      transform: translateY(50%);
      text-align: center;
    }
    .banner-title{
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 15px;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.9), 0 0 10px rgba(0,0,0,0.7);
    }
    .banner-text{
      font-size: 1.3rem;
      margin-bottom: 30px;
      color: #fff;
      font-weight: 600;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.9);
    }
    .btn-banner{
      background: #e74c3c;
      color: white;
      padding: 12px 35px;
      font-size: 1.1rem;
      font-weight: bold;
      border-radius: 50px;
      border: none;
      transition: 0.3s;
    }
    .btn-banner:hover{
      background: #c0392b;
      transform: scale(1.05);
      color: white;
      text-decoration: none;
    }
    </style>


  </head>
  <body>
    <div id="stickyTop">
      {% include "header.html" %}
      {% include "navbar.html" %}
    </div>

    <!-- ëª¨ë°”ì¼ì—ì„œë§Œ ë³´ì´ëŠ” ë§í’ì„  ì¢Œìš° ìŠ¤í¬ë¡¤ ë ˆì¼ -->
    <div id="expiryBubbleRail" class="expiry-bubble-rail" aria-label="ìœ í†µê¸°í•œ ì•Œë¦¼ ë ˆì¼"></div>

    <!-- PCì—ì„œ ë§í’ì„ ì„ ë‹¤ì‹œ ë¶™ì—¬ë‘˜ â€œê±°ì¹˜ëŒ€â€(ìˆ¨ê¸°ì§€ ë§ˆì„¸ìš”) -->
    <div id="expiryBubbleMount" class="expiry-bubble-mount" aria-hidden="true"></div>

    <!-- [NEW] ìœ í†µê¸°í•œ ë§í’ì„  ì•Œë¦¼ -->
    {% if username %}
    {% set dog_items = expiry_alerts.get('dog', []) %}
    {% set cat_items = expiry_alerts.get('cat', []) %}
    {% set bird_items = expiry_alerts.get('bird', []) %}

    {% if dog_items|length > 0 %}
    <div id="expiryBubbleDog" class="expiry-bubble" data-anchor="navDog" data-category="dog">
      <div class="bubble-pointer"></div>
      <div class="bubble-title">ğŸ¶ {{ dog_items[0].product_name }}</div>
      <div>
        {% if dog_items[0].status == 'over' %}
          ì•½ {{ dog_items[0].display_days }}ì¼ <span class="expiry-over">ì´ˆê³¼</span>
        {% else %}
          ì•½ {{ dog_items[0].display_days }}ì¼ <span class="expiry-remaining">ì”ì—¬</span>
        {% endif %}
      </div>

      <div class="bubble-actions">
        <a class="btn btn-sm bubble-btn-buy bubble-btn-buy-top"
          href="/products/{{ dog_items[0].product_id }}">ì¬êµ¬ë§¤</a>

        <button class="btn btn-sm bubble-btn-toggle"
                onclick="toggleBubbleList('dog', this)">ëª¨ë‘ë³´ê¸°</button>

        <button class="bubble-close-square"
                onclick="closeBubble('dog')" aria-label="close">âœ•</button>
      </div>


      <div id="bubbleList-dog" class="bubble-list">
        {% for it in dog_items %}
          <div style="padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.08);">
            <div style="font-weight:700;">{{ it.product_name }}</div>
            <div>
              {% if it.status == 'over' %}
                ì•½ {{ it.display_days }}ì¼ <span class="expiry-over">ì´ˆê³¼</span>
              {% else %}
                ì•½ {{ it.display_days }}ì¼ <span class="expiry-remaining">ì”ì—¬</span>
              {% endif %}
              <a class="btn btn-sm bubble-btn-buy" style="float:right; padding:2px 8px;"
                 href="/products/{{ it.product_id }}">ì¬êµ¬ë§¤</a>
            </div>
          </div>
        {% endfor %}
      </div>

    </div>
    {% endif %}

      {% if cat_items|length > 0 %}
      <div id="expiryBubbleCat" class="expiry-bubble" data-anchor="navCat" data-category="cat">
        <div class="bubble-pointer"></div>
        <div class="bubble-title">ğŸ± {{ cat_items[0].product_name }}</div>
        <div>
          {% if cat_items[0].status == 'over' %}
            ì•½ {{ cat_items[0].display_days }}ì¼ <span class="expiry-over">ì´ˆê³¼</span>
          {% else %}
            ì•½ {{ cat_items[0].display_days }}ì¼ <span class="expiry-remaining">ì”ì—¬</span>
          {% endif %}
        </div>

        <div class="bubble-actions">
          <a class="btn btn-sm bubble-btn-buy bubble-btn-buy-top"
            href="/products/{{ cat_items[0].product_id }}">ì¬êµ¬ë§¤</a>

          <button class="btn btn-sm bubble-btn-toggle"
                  onclick="toggleBubbleList('cat', this)">ëª¨ë‘ë³´ê¸°</button>

          <button class="bubble-close-square"
                  onclick="closeBubble('cat')" aria-label="close">âœ•</button>
        </div>

        <div id="bubbleList-cat" class="bubble-list">
          {% for it in cat_items %}
            <div style="padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.08);">
              <div style="font-weight:700;">{{ it.product_name }}</div>
              <div>
                {% if it.status == 'over' %}
                  ì•½ {{ it.display_days }}ì¼ <span class="expiry-over">ì´ˆê³¼</span>
                {% else %}
                  ì•½ {{ it.display_days }}ì¼ <span class="expiry-remaining">ì”ì—¬</span>
                {% endif %}
                <a class="btn btn-sm bubble-btn-buy" style="float:right; padding:2px 8px;"
                  href="/products/{{ it.product_id }}">ì¬êµ¬ë§¤</a>
              </div>
            </div>
          {% endfor %}
        </div>

      </div>
      {% endif %}

      {% if bird_items|length > 0 %}
      <div id="expiryBubbleBird" class="expiry-bubble" data-anchor="navBird" data-category="bird">
        <div class="bubble-pointer"></div>
        <div class="bubble-title">ğŸ¦ {{ bird_items[0].product_name }}</div>
        <div>
          {% if bird_items[0].status == 'over' %}
            ì•½ {{ bird_items[0].display_days }}ì¼ <span class="expiry-over">ì´ˆê³¼</span>
          {% else %}
            ì•½ {{ bird_items[0].display_days }}ì¼ <span class="expiry-remaining">ì”ì—¬</span>
          {% endif %}
        </div>

        <div class="bubble-actions">
          <a class="btn btn-sm bubble-btn-buy bubble-btn-buy-top"
            href="/products/{{ bird_items[0].product_id }}">ì¬êµ¬ë§¤</a>

          <button class="btn btn-sm bubble-btn-toggle"
                  onclick="toggleBubbleList('bird', this)">ëª¨ë‘ë³´ê¸°</button>

          <button class="bubble-close-square"
                  onclick="closeBubble('bird')" aria-label="close">âœ•</button>
        </div>

        <div id="bubbleList-bird" class="bubble-list">
          {% for it in bird_items %}
            <div style="padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.08);">
              <div style="font-weight:700;">{{ it.product_name }}</div>
              <div>
                {% if it.status == 'over' %}
                  ì•½ {{ it.display_days }}ì¼ <span class="expiry-over">ì´ˆê³¼</span>
                {% else %}
                  ì•½ {{ it.display_days }}ì¼ <span class="expiry-remaining">ì”ì—¬</span>
                {% endif %}
                <a class="btn btn-sm bubble-btn-buy" style="float:right; padding:2px 8px;"
                  href="/products/{{ it.product_id }}">ì¬êµ¬ë§¤</a>
              </div>
            </div>
          {% endfor %}
        </div>

      </div>
      {% endif %}
    {% endif %}
    <!-- #============================== -->

    <div class="container">
      <div class="carousel-container">
        <div
          id="mainBannerCarousel"
          class="carousel slide"
          data-ride="carousel"
          data-interval="6000"
        >
          <ol class="carousel-indicators">
            <li
              data-target="#mainBannerCarousel"
              data-slide-to="0"
              class="active"
            ></li>
            <li data-target="#mainBannerCarousel" data-slide-to="1"></li>
            <li data-target="#mainBannerCarousel" data-slide-to="2"></li>
            <li data-target="#mainBannerCarousel" data-slide-to="3"></li>
            <li data-target="#mainBannerCarousel" data-slide-to="4"></li>
          </ol>

          <div class="carousel-inner">
            <div class="carousel-item active">
              <video
                class="d-block w-100"
                autoplay
                muted
                loop
                playsinline
                style="object-fit: cover; height: 100%"
              >
                <source src="static\video\main_banner.mp4" type="video/mp4" />
              </video>
              <div class="carousel-caption d-none d-md-block">
                <h2 class="banner-title"></h2>
                <p class="banner-text"></p>
                <button class="btn-banner" onclick="location.href='/'">
                  <i class="fas fa-shopping-cart"></i> ì‡¼í•‘ ì‹œì‘í•˜ê¸°
                </button>
              </div>
            </div>

            <div class="carousel-item">
              <img
                src="https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80"
                alt="ê³ ì–‘ì´"
              />
              <div class="carousel-caption d-none d-md-block">
                <h2 class="banner-title">ì§‘ì‚¬ë‹˜ë“¤ ì£¼ëª©!</h2>
                <p class="banner-text">
                  ê¹Œë‹¤ë¡œìš´ ëƒ¥ì´ ì…ë§›ì„ ì‚¬ë¡œì¡ì„<br />í”„ë¦¬ë¯¸ì—„ ê°„ì‹ ê¸°íšì „
                </p>
                <button
                  class="btn-banner"
                  onclick="location.href='/products?category=cat&sub=snack'"
                >
                  <i class="fas fa-fish"></i> ê³ ì–‘ì´ ê°„ì‹ ë³´ëŸ¬ê°€ê¸°
                </button>
              </div>
            </div>

            <div class="carousel-item">
              <img
                src="https://images.unsplash.com/photo-1583337130417-3346a1be7dee?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80"
                alt="ê¸°íƒ€"
              />
              <div class="carousel-caption d-none d-md-block">
                <h2 class="banner-title">ì—„ì²­ë‚œ í™œë™ëŸ‰ !</h2>
                <p class="banner-text">
                  ë‚´ ì²´ë ¥ì„ ê°ë‹¹í•  ìˆ˜ ìˆê² ì–´?<br />ì•„ë‹ˆ ë‚œ ëª»í•´
                </p>
                <button
                  class="btn-banner"
                  onclick="location.href='/products?category=dog&sub=toy'"
                >
                  <i class="fas fa-shopping-bag"></i> ê°•ì•„ì§€ ì¥ë‚œê° ë³´ëŸ¬ê°€ê¸°
                </button>
              </div>
            </div>

            <div class="carousel-item" data-interval="8000">
              <video
                class="d-block w-100"
                autoplay
                muted
                loop
                playsinline
                style="object-fit: cover; height: 100%"
              >
                <source src="static\video\animation.mp4" type="video/mp4" />
              </video>
              <div class="carousel-caption d-none d-md-block">
                <h2 class="banner-title">ë“¤íŒì²˜ëŸ¼ í¸ì•ˆí•œ í•˜ìš°ìŠ¤</h2>
                <p class="banner-text">ìš°ë¦¬ ì•„ì´ë“¤ì˜ í¸ì•ˆí•¨ì„ <br /></p>
                <button class="btn-banner" onclick="location.href='/products?category=cat&sub=house'">
                  <i class="fas fa-play-circle"></i> ê³ ì–‘ì´ í•˜ìš°ìŠ¤ ë³´ëŸ¬ê°€ê¸°
                </button>
              </div>
            </div>

            <div class="carousel-item" data-interval="8000">
              <video
                class="d-block w-100"
                autoplay
                muted
                loop
                playsinline
                style="object-fit: cover; height: 100%"
              >
                <source src="static\video\baby.mp4" type="video/mp4" />
              </video>
              <div class="carousel-caption d-none d-md-block">
                <h2 class="banner-title">ë“ ë“ í•œ ì„±ì¥ì„ ìœ„í•´</h2>
                <p class="banner-text">ì•„ê°€ì•¼ ìë¼ë‚˜ë¼ <br /></p>
                <button class="btn-banner" onclick="location.href='/products?category=dog&sub=clothes'">
                  <i class="fas fa-play-circle"></i> ê°•ì•„ì§€ ì˜· ë³´ëŸ¬ê°€ê¸°
                </button>
              </div>
            </div>
          <a
            class="carousel-control-prev"
            href="#mainBannerCarousel"
            role="button"
            data-slide="prev"
          >
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
          </a>
          <a
            class="carousel-control-next"
            href="#mainBannerCarousel"
            role="button"
            data-slide="next"
          >
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
          </a>
        </div>
      </div>
    </div>

    <div class="container mb-5">
      <!-- <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-star text-warning"></i> MD ì¶”ì²œ ìƒí’ˆ
        </h3>
      </div> -->

      <div class="row">
        {% for product in featured_products %}
        <div class="col-md-3 mb-4">
          <div
            class="card product-card"
            onclick="location.href='/products/{{ product.id }}'"
          >
            <div class="card-img-wrapper">
              <div class="card-badge"><i class="fas fa-heart"></i></div>
              {% if product.image_url %}
              <img
                src="{{ product.image_url }}"
                alt="{{ product.name }}"
                class="card-img-top"
              />
              {% else %}
              <div
                class="d-flex align-items-center justify-content-center h-100 bg-light text-secondary"
              >
                <i class="fas fa-gift fa-3x"></i>
              </div>
              {% endif %}
            </div>
            <div class="card-body">
              <h5 class="card-title">{{ product.name }}</h5>
              <p class="product-price">{{ product.price }}ì›</p>
            </div>
          </div>
        </div>
        {% else %}
        <div class="col-12 text-center">
          <p>ì¶”ì²œ ìƒí’ˆ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
        </div>
        {% endfor %}
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <div id="expiryBubbleMount" class="expiry-bubble-mount" aria-hidden="true"></div>

    {% include "cart_floating.html" %}

    <script>
      // ===============================
      // [NEW] PC: ì•µì»¤ ê¸°ì¤€ fixed ë°°ì¹˜
      //       Mobile: rail(ì¢Œìš° ìŠ¤í¬ë¡¤)ë¡œ ì´ë™
      // ===============================

      function isMobile() {
        return window.matchMedia("(max-width: 680px)").matches;
      }

      function toggleBubbleList(category, btn) {
        const el = document.getElementById(`bubbleList-${category}`);
        if (!el) return;

        const opening = el.style.display !== "block";
        el.style.display = opening ? "block" : "none";

        // ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ê°™ì´ í† ê¸€
        if (btn) btn.textContent = opening ? "ê°ì¶”ê¸°" : "ëª¨ë‘ë³´ê¸°";

        setupExpiryBubbles();
      }

      function closeBubble(category) {
        const bubble = document.getElementById(
          `expiryBubble${category[0].toUpperCase() + category.slice(1)}`
        );
        if (!bubble) return;

        bubble.classList.add("is-closed");   // âœ… í•µì‹¬: ë‹«í˜ ìƒíƒœ í‘œì‹œ
        bubble.style.display = "none";       // ì¦‰ì‹œ ìˆ¨ê¹€(ì²´ê°ìš©)
        setupExpiryBubbles(); // âœ… ë ˆì¼/PC ë°°ì¹˜ ì¦‰ì‹œ ê°±ì‹ 
        
      }

      function positionBubble(bubbleId, anchorId) {
        const bubble = document.getElementById(bubbleId);
        const anchor = document.getElementById(anchorId);
        if (!bubble || !anchor) return;

        // âœ… ë‹«íŒ ë§í’ì„ ì´ë©´ ë‹¤ì‹œ ì—´ì§€ ì•ŠìŒ
        if (bubble.classList.contains("is-closed")) return;

        const rect = anchor.getBoundingClientRect();
        if (!rect || rect.width === 0 || rect.height === 0) {
          bubble.style.display = "none";
          return;
        }

        bubble.style.display = "block";
        bubble.style.position = "fixed";

        const top = rect.bottom + 8;
        let left = rect.left;

        const w = bubble.offsetWidth || 280;
        const maxLeft = window.innerWidth - w - 10;
        if (left > maxLeft) left = maxLeft;
        if (left < 10) left = 10;

        bubble.style.top = `${top}px`;
        bubble.style.left = `${left}px`;
      }

      function positionAllBubbles() {
        const configs = [
          { bubbleId: "expiryBubbleDog",  anchorId: "navDog"  },
          { bubbleId: "expiryBubbleCat",  anchorId: "navCat"  },
          { bubbleId: "expiryBubbleBird", anchorId: "navBird" },
        ];

        // 1) í‘œì‹œ ëŒ€ìƒë§Œ ìˆ˜ì§‘
        const items = configs.map(c => {
          const bubble = document.getElementById(c.bubbleId);
          const anchor = document.getElementById(c.anchorId);
          return { ...c, bubble, anchor };
        }).filter(x => x.bubble && x.anchor && x.bubble.style.display !== "none");

        if (items.length === 0) return;

        // 2) top ê¸°ì¤€: anchorë“¤ì˜ bottom ì¤‘ ìµœëŒ€ê°’ + 8px
        const bottoms = items.map(x => x.anchor.getBoundingClientRect().bottom);
        const top = Math.max(...bottoms) + 8;

        // 3) ë¨¼ì € í‘œì‹œí•´ì„œ width ì¸¡ì • ê°€ëŠ¥í•˜ê²Œ
        items.forEach(x => {
          x.bubble.style.display = "block";
          x.bubble.style.position = "fixed";
          x.bubble.style.top = `${top}px`;
        });

        const vw = window.innerWidth;
        const margin = 10;

        // 4) width + anchor center ê³„ì‚° í›„ center ê¸°ì¤€ ì •ë ¬
        const measured = items.map(x => {
          const a = x.anchor.getBoundingClientRect();
          const w = x.bubble.getBoundingClientRect().width || 280;
          const center = a.left + a.width / 2;
          return { ...x, w, center, left: 0 };
        }).sort((a,b) => a.center - b.center);

        // ë§í’ì„  ê°„ê²©(í­ì˜ 5% ê·¼ì‚¬)
        const avgW = measured.reduce((s,i)=>s+i.w,0) / measured.length;
        const gap = Math.round(Math.max(10, Math.min(24, avgW * 0.05)));

        // 5) center ê¸°ì¤€ìœ¼ë¡œ ì´ˆê¸° left ì„¤ì •
        measured.forEach(it => {
          it.left = Math.round(it.center - it.w/2);
          it.left = Math.max(margin, Math.min(it.left, vw - margin - it.w));
        });

        // 6) ê²¹ì¹¨ ë°©ì§€: ì™¼ìª½â†’ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ê¸°
        for (let i=1; i<measured.length; i++){
          const prev = measured[i-1];
          const cur  = measured[i];
          const minLeft = prev.left + prev.w + gap;
          if (cur.left < minLeft) cur.left = minLeft;
        }

        // 7) ì˜¤ë¥¸ìª½ ë„˜ì¹˜ë©´ ì „ì²´ë¥¼ ì™¼ìª½ìœ¼ë¡œ ë‹¹ê¹€
        const last = measured[measured.length-1];
        const overflow = (last.left + last.w) - (vw - margin);
        if (overflow > 0){
          measured.forEach(it => it.left -= overflow);
        }

        // 8) ê·¸ë£¹ì„ í™”ë©´ ê°€ìš´ë°ë¡œ ì •ë ¬(ê°€ëŠ¥í•œ ë²”ìœ„ ë‚´)
        const groupLeft  = measured[0].left;
        const groupRight = measured[measured.length-1].left + measured[measured.length-1].w;
        const groupW = groupRight - groupLeft;
        const targetLeft = Math.round((vw - groupW) / 2);

        let delta = targetLeft - groupLeft;
        const minDelta = margin - groupLeft;
        const maxDelta = (vw - margin) - groupRight;
        delta = Math.max(minDelta, Math.min(maxDelta, delta));
        measured.forEach(it => it.left += delta);

        // 9) ì ìš©
        measured.forEach(it => {
          it.bubble.style.left = `${it.left}px`;
        });
      }


      document.addEventListener("DOMContentLoaded", () => {
        updateStickyTopHeight();
        // í°íŠ¸/ì´ë¯¸ì§€ ë¡œë”©ìœ¼ë¡œ ë†’ì´ê°€ ëŠ¦ê²Œ ë³€í•˜ëŠ” ê²½ìš° í•œ ë²ˆ ë”
        setTimeout(updateStickyTopHeight, 50);
        setTimeout(() => { updateStickyTopHeight(); positionAllBubbles(); }, 200);
      });

      window.addEventListener("resize", () => {
        updateStickyTopHeight();
        positionAllBubbles();
      });




      // #======================================
      function shouldUseRail(visibleCount) {
        // ë§í’ì„  í­(240) + gap(12) + ì¢Œìš° padding(24) ëŒ€ëµ ê³„ì‚°
        const total = visibleCount * 240 + Math.max(0, visibleCount - 1) * 12 + 24;
        return isMobile() || total > window.innerWidth;
      }

      function updateStickyTopHeight(){
        const sticky = document.getElementById("stickyTop");
        if (!sticky) return;
        const h = sticky.offsetHeight || 0;
        document.documentElement.style.setProperty("--stickyTopH", `${h}px`);
      }

      function setupExpiryBubbles() {
        updateStickyTopHeight();

        const mount = document.getElementById("expiryBubbleMount");
        const rail  = document.getElementById("expiryBubbleRail");

        const bubbles = [
          document.getElementById("expiryBubbleDog"),
          document.getElementById("expiryBubbleCat"),
          document.getElementById("expiryBubbleBird"),
        ].filter(Boolean);

        // âœ… â€œë‹«íŒ ë§í’ì„ â€ ì œì™¸í•˜ê³ ë§Œ ë ˆì¼/ë°°ì¹˜ì— ì‚¬ìš©
        const openBubbles = bubbles.filter(b => !b.classList.contains("is-closed"));

        const useRail = shouldUseRail(openBubbles.length);

        if (useRail) {
          if (mount) mount.style.display = "none";
          if (rail)  rail.style.display  = "flex";

          openBubbles.forEach(b => {
            rail.appendChild(b);

            // âœ… ë ˆì¼ ëª¨ë“œ í´ë˜ìŠ¤ ë¶€ì—¬(ì¤‘ìš”)
            b.classList.add("in-rail");

            // ë ˆì¼ì—ì„œëŠ” static
            b.style.position = "static";
            b.style.left = "";
            b.style.top  = "";
            b.style.display = "block";
          });

        } else {
          if (mount) mount.style.display = "block";
          if (rail)  rail.style.display  = "none";

          // PC ë°°ì¹˜ ëª¨ë“œ: ì›ë˜ mountì— ë¶™ì´ê³  positionAllBubblesë¡œ ì¢Œí‘œ ê³„ì‚°
          bubbles.forEach(b => {
            mount.appendChild(b);

            b.classList.remove("in-rail");

            if (b.classList.contains("is-closed")) {
              b.style.display = "none";
            } else {
              b.style.display = "block";
              b.style.position = "fixed";
            }
          });

          positionAllBubbles();
        }
      }


      window.addEventListener("load", () => {
        updateStickyTopHeight();
        setupExpiryBubbles();
      });
      window.addEventListener("resize", () => {
        updateStickyTopHeight();
        setupExpiryBubbles();
      });

    </script>


  </body>
</html>
