<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>경수오빠못해조 - 게시판</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        .container { margin-top: 30px; max-width: 900px; }
        
        /* 카드 스타일 */
        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #fff;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-3px); }

        .card-header-custom {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .author-info { font-size: 0.9rem; color: #666; font-weight: bold; }
        .author-info i { margin-right: 5px; color: #E74C3C; }

        .memo-title, .memo-content {
            width: 100%;
            border: 1px solid #ddd;
            background-color: #fcfcfc;
            padding: 10px;
            border-radius: 5px;
        }
        .memo-content { min-height: 100px; margin-top: 10px; }

        /* 버튼 스타일 */
        .edit-buttons { text-align: right; margin-top: 10px; }
        .btn-edit { background-color: #E74C3C; color: #fff; border: none; }
        .btn-delete { background-color: #3498DB; color: #fff; border: none; }
        .btn-edit:hover, .btn-delete:hover { opacity: 0.8; color: white; }

        /* 헤더바 스타일 */
        .header-bar {
            background-color: #E74C3C;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        .header-bar h1 { margin: 0; font-size: 1.5rem; font-weight: bold; }

        /* 검색창 스타일 */
        .search-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
    <script>
        // 메모 작성
        function createMemo() {
            var title = document.getElementById('new-title').value;
            var content = document.getElementById('new-content').value;

            if(!title || !content) { alert('제목과 내용을 입력해주세요.'); return; }

            fetch('/memos/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: title, content: content })
            })
            .then(response => response.json())
            .then(data => {
                window.location.reload(); 
            })
            .catch((error) => console.error('Error:', error));
        }

        // 수정 모드 전환
        function toggleEdit(id) {
            var titleEl = document.getElementById('title-' + id);
            var contentEl = document.getElementById('content-' + id);
            var btnDiv = document.getElementById('btn-group-' + id);
            
            var isReadOnly = titleEl.readOnly;
            titleEl.readOnly = !isReadOnly;
            contentEl.readOnly = !isReadOnly;

            if (!isReadOnly) {
                // 저장 로직
                updateMemo(id);
            } else {
                // 수정 모드 진입 시 시각적 효과 (선택 사항)
                titleEl.focus();
                // 버튼 아이콘 변경 로직 등을 추가할 수 있음
            }
        }

        // 메모 업데이트
        function updateMemo(id) {
            var title = document.getElementById('title-' + id).value;
            var content = document.getElementById('content-' + id).value;

            fetch('/memos/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: title, content: content })
            })
            .then(response => {
                if (response.ok) {
                    alert('메모가 수정되었습니다.');
                    window.location.reload(); // 읽기 전용으로 되돌리기 위해 리로드
                } else {
                    alert('수정 권한이 없습니다.');
                    window.location.reload();
                }
            });
        }

        // 메모 삭제
        function deleteMemo(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;

            fetch('/memos/' + id, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('삭제 권한이 없습니다.');
                }
            });
        }

        function logout() {
            fetch('/auth/logout', { method: 'POST' })
            .then(() => window.location.href = '/');
        }

        // 검색 폼 제출 (GET 방식)
        function submitSearch() {
            const form = document.getElementById('searchForm');
            form.submit();
        }

        // 내 글만 보기 토글
        function toggleMyPosts() {
            const checkBox = document.getElementById('showMineCheck');
            const urlParams = new URLSearchParams(window.location.search);
            
            if (checkBox.checked) {
                urlParams.set('show_mine', 'true');
            } else {
                urlParams.delete('show_mine');
            }
            window.location.search = urlParams.toString();
        }
    </script>
</head>

<body>
    <div class="container">
        <div class="header-bar">
            <div>
                <a href="/main" class="btn btn-light btn-sm mr-2"><i class="fas fa-home"></i> 메인으로</a>
            </div>
            <h1><i class="fas fa-clipboard-list"></i> 자유 게시판</h1>
            <div>
                <span class="mr-2"><i class="fas fa-user"></i> {{ username }}</span>
                <button onclick="logout()" class="btn btn-outline-light btn-sm">로그아웃</button>
            </div>
        </div>

        <div class="search-container">
            <form id="searchForm" method="GET" action="/memos/" class="form-inline justify-content-between">
                <div class="custom-control custom-switch my-1">
                    <input type="checkbox" class="custom-control-input" id="showMineCheck" onchange="toggleMyPosts()" 
                           {% if show_mine %}checked{% endif %}>
                    <label class="custom-control-label font-weight-bold" for="showMineCheck">내 글만 보기</label>
                </div>

                <div class="input-group my-1">
                    <select name="search_type" class="custom-select">
                        <option value="title" {% if search_type == 'title' %}selected{% endif %}>제목</option>
                        <option value="username" {% if search_type == 'username' %}selected{% endif %}>작성자(ID)</option>
                        <option value="content" {% if search_type == 'content' %}selected{% endif %}>내용</option>
                    </select>
                    <input type="text" name="keyword" class="form-control" placeholder="검색어 입력" value="{{ keyword }}">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i> 검색</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="card bg-light border-primary">
            <div class="card-body">
                <h5 class="card-title text-primary"><i class="fas fa-pencil-alt"></i> 새 글 작성</h5>
                <input type="text" id="new-title" placeholder="제목을 입력하세요" class="form-control mb-2">
                <textarea id="new-content" placeholder="내용을 자유롭게 작성하세요" class="form-control mb-2" rows="3"></textarea>
                <button onclick="createMemo()" class="btn btn-primary btn-block">등록하기</button>
            </div>
        </div>

        <hr>

        {% if not memos %}
            <div class="alert alert-warning text-center">검색 결과가 없거나 게시글이 없습니다.</div>
        {% endif %}

        {% for memo in memos %}
        <div class="card">
            <div class="card-header-custom">
                <span class="author-info">
                    <i class="fas fa-user-circle"></i> {{ memo.username }}
                </span>
                <small class="text-muted">No. {{ memo.id }}</small>
            </div>
            <div class="card-body">               
                <input type="text" id="title-{{ memo.id }}" value="{{ memo.title }}" class="form-control memo-title mb-2" readonly>
                <textarea id="content-{{ memo.id }}" class="form-control memo-content" readonly>{{ memo.content }}</textarea>
                
                {% if memo.user_id == current_user_id %}
                <div class="edit-buttons" id="btn-group-{{ memo.id }}">
                    <button onclick="toggleEdit({{ memo.id }})"  class="btn btn-sm btn-edit"><i class="fas fa-edit"></i> 수정</button>
                    <button onclick="deleteMemo({{ memo.id }})" class="btn btn-sm btn-delete"><i class="fas fa-trash-alt"></i> 삭제</button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</body>
</html>