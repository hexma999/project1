<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>{{ product.name }} - 경수오빠못해조</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background-color: #f8f9fa;
      }

      /* ... 기존 스타일 유지 ... */
      .header-bar {
        background-color: #e74c3c;
        color: white;
        padding: 15px 0;
        margin-bottom: 30px;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
        text-decoration: none;
      }
      .product-container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      .product-img {
        width: 100%;
        height: 400px;
        object-fit: cover;
        border-radius: 10px;
        background-color: #eee;
      }
      .product-title {
        font-weight: bold;
        font-size: 1.8rem;
        margin-bottom: 10px;
      }
      .product-price {
        color: #e74c3c;
        font-weight: bold;
        font-size: 1.5rem;
        margin-bottom: 20px;
      }

      /* ★ 플로팅 버튼 스타일 (우측 하단 고정) ★ */
      .floating-buttons {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .float-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .float-btn:hover {
        transform: scale(1.1);
      }
      .btn-review {
        background-color: #ffc107;
        color: #333;
      } /* 노란색 (의견) */
      .btn-top {
        background-color: #333;
      } /* 검은색 (위로) */

      /* ★ 모달 스타일 (의견 작성창) ★ */
      .modal-overlay {
        display: none; /* 평소에는 숨김 */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }
      .review-modal {
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="header-bar">
      <div class="container d-flex justify-content-between align-items-center">
        <a href="/main" class="logo"
          ><i class="fas fa-paw"></i> 경수오빠못해조</a
        >
        <div>
          <a href="/main" class="btn btn-outline-light btn-sm">메인으로</a>
          <button
            onclick="history.back()"
            class="btn btn-outline-light btn-sm ml-2"
          >
            뒤로가기
          </button>
        </div>
      </div>
    </div>

    <div class="container mb-5">
      <div class="product-container">
        <div class="row">
          <div class="col-md-6 mb-4">
            <img
              src="{{ product.image_url if product.image_url else 'https://via.placeholder.com/400' }}"
              alt="{{ product.name }}"
              class="product-img"
            />
          </div>
          <div class="col-md-6">
            <span class="badge badge-danger mb-2"
              >{{ product.category | upper }}</span
            >
            <h1 class="product-title">{{ product.name }}</h1>
            <p class="text-muted">{{ product.description }}</p>
            <p class="product-price">{{ product.price }}원</p>

            <div class="input-group mb-3" style="max-width: 150px">
              <div class="input-group-prepend">
                <button class="btn btn-outline-secondary" type="button">
                  -
                </button>
              </div>
              <input
                type="text"
                class="form-control text-center"
                value="1"
                readonly
              />
              <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button">
                  +
                </button>
              </div>
            </div>

            <button class="btn btn-lg btn-outline-danger btn-block mb-2">
              <i class="fas fa-shopping-cart"></i> 장바구니 담기
            </button>
            <button class="btn btn-lg btn-danger btn-block">구매하기</button>
          </div>
        </div>

        <div class="mt-5">
          <h4>상품 상세 정보</h4>
          <div class="mt-5 mb-5">
            <hr />
            <div
              class="product-detail-box bg-light p-3 rounded"
              style="min-height: 200px"
            >
              {% if product.detail %} {{ product.detail | safe }} {% else %}
              <p class="text-muted text-center py-5">
                상세 설명이 준비 중입니다.
              </p>
              {% endif %}
            </div>
          </div>
          <h4>
            <i class="fas fa-comments"></i> 구매 후기
            <span class="badge badge-warning">{{ reviews|length }}</span>
          </h4>
          <hr />

          <div class="review-list">
            {% for review in reviews %}
            <div class="card mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <h6 class="card-subtitle mb-2 text-muted">
                    <i class="fas fa-user-circle"></i> {{ review.username }}님
                  </h6>
                  <small class="text-secondary"
                    >{{ review.created_at.strftime('%Y-%m-%d %H:%M') }}</small
                  >
                </div>
                <p class="card-text mt-2">{{ review.content }}</p>
              </div>
            </div>
            {% else %}
            <div class="text-center py-5 bg-light rounded">
              <i class="far fa-comment-dots fa-3x text-muted mb-3"></i>
              <p class="text-muted">
                아직 작성된 후기가 없습니다.<br />첫 번째 후기의 주인공이
                되어보세요!
              </p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="floating-buttons">
      <button
        class="float-btn btn-review"
        onclick="openReviewModal()"
        title="의견 남기기"
      >
        <i class="fas fa-comment-dots"></i>
      </button>
      <button class="float-btn btn-top" onclick="scrollToTop()" title="맨 위로">
        <i class="fas fa-arrow-up"></i>
      </button>
    </div>

    <div id="reviewModal" class="modal-overlay">
      <div class="review-modal">
        <h4><i class="fas fa-pen"></i> 이 상품 어때요?</h4>
        <hr />
        <div class="form-group">
          <label>상품에 대한 솔직한 의견을 남겨주세요!</label>
          <textarea
            id="reviewContent"
            class="form-control"
            rows="4"
            placeholder="예: 우리 강아지가 너무 잘 먹어요!"
          ></textarea>
        </div>
        <div class="text-right">
          <button class="btn btn-secondary" onclick="closeReviewModal()">
            취소
          </button>
          <button
            class="btn btn-primary"
            onclick="submitReview({{ product.id }})"
          >
            등록하기
          </button>
        </div>
      </div>
    </div>

    <script>
      // 1. 맨 위로 가기 기능
      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // 2. 모달 열기
      function openReviewModal() {
        document.getElementById("reviewModal").style.display = "flex";
      }

      // 3. 모달 닫기
      function closeReviewModal() {
        document.getElementById("reviewModal").style.display = "none";
      }

      // 4. 리뷰 전송 (AJAX Fetch)
      function submitReview(productId) {
        let content = document.getElementById("reviewContent").value;

        fetch("/products/" + productId + "/review", {
          // URL은 예시입니다
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: content }),
        })
          .then((res) => res.json())
          .then((data) => {
            console.log(data); // ★ 콘솔에서 서버가 준 진짜 변수명을 확인하세요!

            // 예: 만약 콘솔에 { result: "success" } 라고 뜬다면
            // alert(data.result); 라고 써야 합니다.

            if (data.message) {
              alert(data.message);
              location.reload(); // 성공 후 새로고침
            } else {
              // 만약 메시지가 없다면 그냥 직접 텍스트를 띄우세요
              alert("리뷰가 등록되었습니다!");
              location.reload();
            }
          });
      }
      // 5. 수량 변경 기능 (+, - 버튼)
      document.addEventListener("DOMContentLoaded", function () {
        const minusBtn = document.querySelector(".input-group-prepend button");
        const plusBtn = document.querySelector(".input-group-append button");
        const quantityInput = document.querySelector(".input-group input");

        if (minusBtn && plusBtn && quantityInput) {
          minusBtn.addEventListener("click", function () {
            let currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
              quantityInput.value = currentValue - 1;
            }
          });

          plusBtn.addEventListener("click", function () {
            let currentValue = parseInt(quantityInput.value);
            // 재고 제한이 있다면 여기에 조건을 추가할 수 있습니다 (예: if(currentValue < 10)...)
            quantityInput.value = currentValue + 1;
          });
        }
      });
    </script>
  </body>
</html>
